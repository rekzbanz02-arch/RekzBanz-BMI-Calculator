<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PNP BMI Calculator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=Nunito+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg: #f7f8fc;
    --surface: #ffffff;
    --surface2: #f0f2f8;
    --border: #e2e5f0;
    --border-strong: #c9cedf;
    --text: #1a1d2e;
    --muted: #8890a8;
    --accent: #4461f2;
    --accent-light: rgba(68,97,242,0.08);
    --accent-mid: rgba(68,97,242,0.18);
    --green: #0ea06a;
    --yellow: #d97b06;
    --orange: #e05c1a;
    --red: #d93025;
    --red2: #a81c14;
    --radius: 16px;
    --shadow-sm: 0 1px 3px rgba(20,25,60,0.06), 0 4px 12px rgba(20,25,60,0.04);
    --shadow-md: 0 2px 8px rgba(20,25,60,0.06), 0 8px 24px rgba(20,25,60,0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Nunito Sans', sans-serif;
    min-height: 100vh;
    padding: 40px 16px 80px;
  }

  .container { max-width: 640px; margin: 0 auto; }

  /* HEADER */
.header { text-align: center; margin-bottom: 24px; }
.header-actions {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 8px;
  margin-top: 16px;
}
  .header-badge {
    display: inline-block;
    background: var(--accent-light);
    border: 1.5px solid var(--accent-mid);
    color: var(--accent);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 2.5px;
    text-transform: uppercase;
    padding: 5px 16px;
    border-radius: 50px;
    margin-bottom: 16px;
    font-family: 'DM Mono', monospace;
  }
  .header h1 {
    font-family: 'Syne', sans-serif;
    font-size: clamp(2rem, 7vw, 3rem);
    font-weight: 800;
    letter-spacing: -1px;
    line-height: 1.1;
    color: var(--text);
  }
  .header p { color: var(--muted); font-size: 14px; margin-top: 8px; font-weight: 400; }

  /* CONNECTION STATUS */
  .conn-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 11px 18px;
    border-radius: 12px;
    margin-bottom: 24px;
    font-size: 13px;
    font-weight: 600;
    border: 1.5px solid;
    transition: all 0.4s;
    font-family: 'Nunito Sans', sans-serif;
  }
  .conn-bar.checking {
    background: var(--surface2);
    border-color: var(--border);
    color: var(--muted);
  }
  .conn-bar.connected {
    background: rgba(14,160,106,0.06);
    border-color: rgba(14,160,106,0.2);
    color: var(--green);
  }
  .conn-bar.failed {
    background: rgba(217,48,37,0.06);
    border-color: rgba(217,48,37,0.2);
    color: var(--red);
  }
  .conn-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
    background: currentColor;
  }
  .conn-bar.checking .conn-dot { animation: pulse 1s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* RESULT CARD */
  .result-card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-top: 3px solid var(--result-color, var(--green));
    border-radius: var(--radius);
    padding: 16px 18px;
    margin-bottom: 20px;
    display: none;
    position: relative;
    overflow: visible;
    box-shadow: var(--shadow-md);
    transition: border-top-color 0.3s;
  }
  .result-card.visible { display: block; animation: slideDown 0.4s cubic-bezier(0.34,1.56,0.64,1); }
  .result-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  .result-top-left { flex: 0 0 auto; }
  .bmi-display { display: flex; align-items: baseline; gap: 4px; }
  .bmi-number {
    font-family: 'Syne', sans-serif;
    font-size: 2.4rem;
    font-weight: 800;
    line-height: 1;
    color: var(--result-color, var(--green));
    transition: color 0.3s;
    letter-spacing: -1px;
    white-space: nowrap;
  }
  .bmi-label { color: var(--muted); font-size: 10px; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1.5px; font-family: 'DM Mono', monospace; }
  .result-badges { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; flex-shrink: 0; }
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 50px;
    font-size: 11px;
    font-weight: 700;
    border: 1.5px solid;
    letter-spacing: 0.2px;
    white-space: nowrap;
  }
  .badge-category { background: var(--surface2); border-color: var(--border); color: var(--text); }
  .badge-pnp-ok { background: rgba(14,160,106,0.08); border-color: rgba(14,160,106,0.25); color: var(--green); }
  .badge-pnp-no { background: rgba(217,48,37,0.08); border-color: rgba(217,48,37,0.25); color: var(--red); }
  .result-meta { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); display: flex; gap: 12px; flex-wrap: wrap; }
  .meta-item { font-size: 12px; color: var(--muted); font-weight: 500; }
  .meta-item span { color: var(--text); font-weight: 700; }
  .export-btn {
    margin-top: 12px;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    color: var(--text);
    padding: 7px 14px;
    border-radius: 10px;
    cursor: pointer;
    font-family: 'Nunito Sans', sans-serif;
    font-size: 13px;
    font-weight: 700;
    transition: all 0.2s;
  }
  .export-btn:hover { background: var(--border); border-color: var(--border-strong); }

  /* FORM CARD */
  .card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 16px;
    box-shadow: var(--shadow-sm);
  }
  .card-title {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 20px;
    font-family: 'DM Mono', monospace;
  }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
  .form-row.single { grid-template-columns: 1fr; }
  @media(max-width: 480px) { .form-row { grid-template-columns: 1fr; } }

  .field { display: flex; flex-direction: column; gap: 7px; position: relative; }
  .field label { font-size: 11px; font-weight: 700; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; font-family: 'DM Mono', monospace; }
  .field input, .field select {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-family: 'Nunito Sans', sans-serif;
    font-size: 15px;
    font-weight: 500;
    padding: 12px 14px;
    transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    outline: none;
    width: 100%;
  }
  .field input:focus, .field select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(68,97,242,0.1);
    background: var(--surface);
  }
  .field-hint { font-size: 11px; color: var(--muted); }

  /* HEIGHT INPUT ROW */
  .height-input-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
    margin-bottom: 14px;
  }
  .height-input-row .field { flex: 1; }
  .height-convert-btn {
    flex-shrink: 0;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    color: var(--accent);
    font-size: 16px;
    width: 46px;
    height: 46px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    margin-bottom: 0;
    font-weight: 700;
  }
  .height-convert-btn:hover {
    background: var(--accent-light);
    border-color: rgba(68,97,242,0.3);
  }

  /* HEIGHT CONVERTER MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(10,14,40,0.5);
    backdrop-filter: blur(6px);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    width: 100%;
    max-width: 420px;
    animation: modalPop 0.3s cubic-bezier(0.34,1.56,0.64,1);
    position: relative;
    box-shadow: var(--shadow-md);
  }
  @keyframes modalPop {
    from { opacity: 0; transform: scale(0.92) translateY(10px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }
  .modal-title {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 20px;
    font-family: 'DM Mono', monospace;
  }
  .modal-close {
    position: absolute;
    top: 16px; right: 16px;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    color: var(--muted);
    width: 32px; height: 32px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    font-weight: 700;
  }
  .modal-close:hover { color: var(--text); border-color: var(--border-strong); background: var(--border); }
  .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px; }
  .modal-apply-btn {
    width: 100%;
    background: var(--accent);
    border: none;
    border-radius: 12px;
    color: white;
    font-family: 'Nunito Sans', sans-serif;
    font-size: 14px;
    font-weight: 700;
    padding: 13px;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: all 0.2s;
  }
  .modal-apply-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(68,97,242,0.35); background: #3450d4; }

  /* HISTORY */
  .history-card { display: none; }
  .history-card.visible { display: block; }
  .history-list { display: flex; flex-direction: column; gap: 10px; }
  .history-item {
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    padding: 13px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    animation: fadeIn 0.3s ease;
    transition: border-color 0.2s;
  }
  .history-item:hover { border-color: var(--border-strong); }
  .history-bmi { font-family: 'Syne', sans-serif; font-size: 1.4rem; font-weight: 700; letter-spacing: -0.5px; }
  .history-meta { font-size: 12px; color: var(--muted); margin-top: 2px; font-weight: 500; }
  .history-badges { display: flex; gap: 6px; flex-wrap: wrap; }
  .history-badge { font-size: 11px; padding: 3px 10px; border-radius: 50px; font-weight: 700; border: 1.5px solid; font-family: 'DM Mono', monospace; }

  /* DROPDOWN */
  .dropdown { margin-bottom: 16px; }
  .dropdown-toggle {
    width: 100%;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    color: var(--muted);
    padding: 14px 20px;
    font-family: 'Nunito Sans', sans-serif;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
    letter-spacing: 0.3px;
    transition: all 0.2s;
    box-shadow: var(--shadow-sm);
  }
  .dropdown-toggle:hover { color: var(--text); border-color: var(--border-strong); }
  .dropdown-arrow { transition: transform 0.3s; font-size: 11px; }
  .dropdown-toggle.open .dropdown-arrow { transform: rotate(180deg); }
  .dropdown-content {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-top: none;
    border-radius: 0 0 var(--radius) var(--radius);
    padding: 20px;
    display: none;
    box-shadow: var(--shadow-sm);
  }
  .dropdown-content.open { display: block; }
  .formula-box {
    background: var(--accent-light);
    border: 1.5px solid var(--accent-mid);
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 18px;
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    color: var(--accent);
    text-align: center;
    font-weight: 500;
  }
  .std-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 18px; }
  .std-table th { text-align: left; padding: 8px 12px; color: var(--muted); font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1.5px solid var(--border); font-family: 'DM Mono', monospace; font-weight: 700; }
  .std-table td { padding: 9px 12px; border-bottom: 1px solid var(--border); font-weight: 500; color: var(--text); }
  .std-table tr:last-child td { border-bottom: none; }
  .std-table tbody tr:hover { background: var(--surface2); }
  .color-dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%; margin-right: 8px; }

  /* CALCULATE BTN */
  .calc-btn {
    width: 100%;
    background: var(--accent);
    border: none;
    border-radius: 14px;
    color: white;
    font-family: 'Syne', sans-serif;
    font-size: 15px;
    font-weight: 700;
    padding: 16px;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: all 0.2s;
    box-shadow: 0 4px 18px rgba(68,97,242,0.3);
    margin-top: 8px;
  }
  .calc-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(68,97,242,0.4); background: #3450d4; }
  .calc-btn:active { transform: translateY(0); }

  /* SAVE STATUS */
  .save-status { text-align: center; font-size: 12px; margin-top: 8px; height: 18px; transition: all 0.3s; font-weight: 600; }
  .save-status.saving { color: var(--muted); }
  .save-status.saved { color: var(--green); }
  .save-status.error { color: var(--red); }

  /* ANIMATIONS */
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-16px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateX(-8px); }
    to { opacity: 1; transform: translateX(0); }
  }

  /* LOADING SPINNER */
  .spinner { display: inline-block; width: 13px; height: 13px; border: 2px solid rgba(136,144,168,0.25); border-top-color: var(--muted); border-radius: 50%; animation: spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  @keyframes shake {
  0% { transform: translateX(0); }
  20% { transform: translateX(-6px); }
  40% { transform: translateX(6px); }
  60% { transform: translateX(-4px); }
  80% { transform: translateX(4px); }
  100% { transform: translateX(0); }
}

/* â”€â”€ KG TO LOSE BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kg-lose-banner {
  margin-top: 12px;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 600;
  display: none;
  align-items: center;
  gap: 10px;
  border: 1.5px solid;
  animation: fadeIn 0.4s ease;
}
.kg-lose-banner.visible { display: flex; }
.kg-lose-banner.overweight {
  background: rgba(217,123,6,0.07);
  border-color: rgba(217,123,6,0.2);
  color: var(--yellow);
}
.kg-lose-banner.obese {
  background: rgba(217,48,37,0.07);
  border-color: rgba(217,48,37,0.2);
  color: var(--red);
}
.kg-lose-banner.underweight {
  background: rgba(68,97,242,0.07);
  border-color: rgba(68,97,242,0.2);
  color: var(--accent);
}
.kg-lose-banner.normal {
  background: rgba(14,160,106,0.07);
  border-color: rgba(14,160,106,0.2);
  color: var(--green);
}
.kg-lose-icon { font-size: 15px; flex-shrink: 0; }
.kg-lose-text { line-height: 1.5; font-size: 12px; }
.kg-lose-value { font-family: 'Nunito Sans', sans-serif; font-size: 1em; font-weight: 800; }

/* â”€â”€ HELP TOOLTIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field-header { display: flex; align-items: center; gap: 6px; }
.help-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 16px; height: 16px;
  border-radius: 50%;
  background: var(--surface2);
  border: 1.5px solid var(--border);
  color: var(--muted);
  font-size: 9px;
  font-weight: 800;
  cursor: pointer;
  position: relative;
  flex-shrink: 0;
  transition: all 0.2s;
  line-height: 1;
  font-family: 'DM Mono', monospace;
}
.help-btn:hover { background: var(--accent-light); border-color: rgba(68,97,242,0.4); color: var(--accent); }
.tooltip {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  border: none;
  border-radius: 10px;
  padding: 10px 13px;
  font-size: 12px;
  font-weight: 500;
  color: #f0f2f8;
  box-shadow: 0 8px 24px rgba(10,14,40,0.2);
  pointer-events: none;
  opacity: 0;
  transform: translateX(-50%) translateY(4px);
  transition: opacity 0.2s, transform 0.2s;
  z-index: 999;
  text-transform: none;
  letter-spacing: 0;
  width: max-content;
  max-width: 220px;
  white-space: normal;
  text-align: center;
  font-family: 'Nunito Sans', sans-serif;
}
.tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 5px solid transparent;
  border-top-color: var(--text);
}
.help-btn:hover .tooltip,
.help-btn:focus .tooltip {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* â”€â”€ AUTOCOMPLETE DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.name-wrapper { position: relative; }
.autocomplete-list {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  box-shadow: var(--shadow-md);
  z-index: 500;
  overflow: hidden;
  display: none;
  animation: fadeIn 0.15s ease;
}
.autocomplete-list.visible { display: block; }
.autocomplete-item {
  padding: 11px 14px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background 0.15s;
  border-bottom: 1px solid var(--border);
  font-weight: 500;
}
.autocomplete-item:last-child { border-bottom: none; }
.autocomplete-item:hover, .autocomplete-item.active { background: var(--accent-light); }
.autocomplete-item-icon { font-size: 14px; color: var(--muted); }
.autocomplete-item-name { font-weight: 700; color: var(--text); }
.autocomplete-item-meta { font-size: 11px; color: var(--muted); margin-top: 1px; }
.autocomplete-header {
  padding: 7px 14px;
  font-size: 9px;
  font-weight: 800;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  font-family: 'DM Mono', monospace;
}

/* â”€â”€ SEARCH HELP TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.name-hint {
  font-size: 11px;
  color: var(--muted);
  margin-top: 5px;
  display: flex;
  align-items: center;
  gap: 5px;
  font-weight: 500;
}
.name-hint .hint-icon { font-size: 10px; }

/* â”€â”€ HELP MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.help-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(10,14,40,0.5);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 2000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  opacity: 0;
  transition: opacity 0.25s ease;
}
.help-modal-overlay.open {
  display: flex;
  opacity: 1;
}
.help-modal-overlay.closing {
  opacity: 0;
}
.help-modal {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 20px;
  width: 100%;
  max-width: 480px;
  max-height: 85vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 24px 64px rgba(10,14,40,0.18), 0 4px 16px rgba(10,14,40,0.1);
  transform: translateY(20px) scale(0.97);
  transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), opacity 0.25s ease;
  opacity: 0;
}
.help-modal-overlay.open .help-modal {
  transform: translateY(0) scale(1);
  opacity: 1;
}
.help-modal-overlay.closing .help-modal {
  transform: translateY(12px) scale(0.97);
  opacity: 0;
}

/* Scrollbar styling */
.help-modal::-webkit-scrollbar { width: 4px; }
.help-modal::-webkit-scrollbar-track { background: transparent; }
.help-modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

.help-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px 16px;
  border-bottom: 1.5px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--surface);
  z-index: 1;
  border-radius: 20px 20px 0 0;
}
.help-modal-title {
  font-family: 'Syne', sans-serif;
  font-size: 17px;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.3px;
}
.help-modal-close {
  width: 32px; height: 32px;
  border-radius: 50%;
  background: var(--surface2);
  border: 1.5px solid var(--border);
  color: var(--muted);
  font-size: 14px;
  font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
}
.help-modal-close:hover { background: var(--border); color: var(--text); border-color: var(--border-strong); }
.help-modal-body {
  padding: 20px 24px 24px;
}
.help-section { margin-bottom: 22px; }
.help-section:last-child { margin-bottom: 0; }
.help-section-title {
  font-size: 10px;
  font-weight: 800;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--accent);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: 'DM Mono', monospace;
}
.help-step {
  display: flex;
  gap: 12px;
  margin-bottom: 10px;
  font-size: 13px;
  color: var(--text);
  line-height: 1.6;
  font-weight: 500;
}
.help-step:last-child { margin-bottom: 0; }
.help-step-num {
  width: 22px; height: 22px;
  border-radius: 50%;
  background: var(--accent-light);
  border: 1.5px solid var(--accent-mid);
  color: var(--accent);
  font-size: 10px;
  font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  margin-top: 1px;
  font-family: 'DM Mono', monospace;
}
.help-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: var(--accent-light);
  border: 1.5px solid var(--accent-mid);
  color: var(--accent);
  font-size: 11px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 50px;
}
.help-divider {
  height: 1.5px;
  background: var(--border);
  margin: 18px 0;
  border: none;
}

/* Help toggle button */
.help-toggle-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--surface);
  border: 1.5px solid var(--border);
  color: var(--muted);
  font-family: 'Nunito Sans', sans-serif;
  font-size: 12px;
  font-weight: 700;
  padding: 5px 12px;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: var(--shadow-sm);
}
.help-toggle-btn:hover { color: var(--text); border-color: var(--border-strong); background: var(--surface2); }

.field input.error {
  border-color: var(--red);
  box-shadow: 0 0 0 3px rgba(217,48,37,0.12);
  animation: shake 0.35s ease;
}

/* â”€â”€ LIGHT THEME (default, no data-theme needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* â”€â”€ DARK THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
[data-theme="dark"] {
  --bg: #0d0f18;
  --surface: #151823;
  --surface2: #1c1f2e;
  --border: #252840;
  --border-strong: #353860;
  --text: #e8eaf5;
  --muted: #6b7090;
  --accent: #5a78f5;
  --accent-light: rgba(90,120,245,0.1);
  --accent-mid: rgba(90,120,245,0.2);
  --green: #1dbf7a;
  --yellow: #e8950d;
  --orange: #f06b28;
  --red: #f03535;
  --red2: #b81c1c;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.2);
  --shadow-md: 0 2px 8px rgba(0,0,0,0.3), 0 8px 24px rgba(0,0,0,0.25);
}

[data-theme="dark"] body {
  background-image: radial-gradient(ellipse at 15% 0%, rgba(68,97,242,0.08) 0%, transparent 55%),
                    radial-gradient(ellipse at 85% 100%, rgba(90,50,140,0.06) 0%, transparent 55%);
}

[data-theme="dark"] .help-modal {
  box-shadow: 0 24px 64px rgba(0,0,0,0.5), 0 4px 16px rgba(0,0,0,0.3);
}

[data-theme="dark"] .tooltip {
  background: #e8eaf5;
  color: #151823;
}
[data-theme="dark"] .tooltip::after {
  border-top-color: #e8eaf5;
}

/* â”€â”€ THEME TOGGLE BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.theme-toggle {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 50px;
  padding: 5px 12px;
  cursor: pointer;
  font-family: 'Nunito Sans', sans-serif;
  font-size: 11px;
  font-weight: 700;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.2s;
  box-shadow: var(--shadow-sm);
}
.theme-toggle:hover {
  color: var(--text);
  border-color: var(--border-strong);
}
.theme-toggle .theme-icon { font-size: 12px; }
	
</style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <h1>BMI Calculator</h1>
      <p>Body Mass Index Assessment with PNP Standards</p>
      <div class="header-actions">
        <button class="help-toggle-btn" onclick="toggleHelp()" id="helpToggleBtn">â“ Help</button>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">
          <span class="theme-icon">ğŸŒ™</span>
          <span id="themeLabel">Dark</span>
        </button>
      </div>
    </div>

  <!-- CONNECTION STATUS BAR -->
  <div class="conn-bar checking" id="connBar">
    <div class="conn-dot"></div>
    <span id="connText">Verifying Google Sheets connectionâ€¦</span>
  </div>

  <!-- RESULT CARD -->
  <div class="result-card" id="resultCard">
    <div class="result-top">
      <div class="result-top-left">
        <div class="bmi-label">BMI Score</div>
        <div class="bmi-display">
          <div class="bmi-number" id="bmiNumber">â€”</div>
        </div>
      </div>
      <div class="result-badges">
        <div class="badge badge-category" id="categoryBadge">â€”</div>
        <div class="badge" id="pnpBadge">â€”</div>
      </div>
    </div>
    <div class="result-meta">
      <div class="meta-item">Name: <span id="rName">â€”</span></div>
      <div class="meta-item">Age: <span id="rAge">â€”</span></div>
      <div class="meta-item">Weight: <span id="rWeight">â€”</span></div>
      <div class="meta-item">Height: <span id="rHeight">â€”</span></div>
      <div class="meta-item">Date: <span id="rDate">â€”</span></div>
    </div>
    <!-- KG TO LOSE BANNER -->
    <div class="kg-lose-banner" id="kgLoseBanner">
      <span class="kg-lose-icon" id="kgLoseIcon">âš–ï¸</span>
      <span class="kg-lose-text" id="kgLoseText"></span>
    </div>
    <button class="export-btn" onclick="exportTxt()">â¬‡ Export to .txt</button>
    <div class="save-status" id="saveStatus"></div>
  </div>

  <!-- HELP PANEL -->
  <div class="help-modal-overlay" id="helpModal" onclick="handleHelpOverlayClick(event)">
    <div class="help-modal" id="helpModalBox">
      <div class="help-modal-header">
        <div class="help-modal-title">ğŸ“– How to use this app</div>
        <button class="help-modal-close" onclick="closeHelp()">âœ•</button>
      </div>
      <div class="help-modal-body">

        <div class="help-section">
          <div class="help-section-title">ğŸš€ Quick Start Guide</div>
          <div class="help-step"><div class="help-step-num">1</div><div>Type your <strong>Full Name</strong> â€” the app will automatically search for your past BMI history from Google Sheets as you type (after 2+ characters).</div></div>
          <div class="help-step"><div class="help-step-num">2</div><div>Enter your <strong>Age</strong>, <strong>Weight</strong> (in kg), and <strong>Height</strong> (in meters). Use the <span class="help-chip">â‡… converter</span> button if you know your height in feet/inches or centimeters.</div></div>
          <div class="help-step"><div class="help-step-num">3</div><div>Click <span class="help-chip">Calculate BMI</span> to get your result. It also shows how many <strong>kg to lose or gain</strong> to reach a healthy BMI.</div></div>
          <div class="help-step"><div class="help-step-num">4</div><div>Your result is <strong>automatically saved</strong> to Google Sheets (cloud). You can also <span class="help-chip">â¬‡ Export to .txt</span> for a printable record.</div></div>
        </div>

        <hr class="help-divider">

        <div class="help-section">
          <div class="help-section-title">ğŸ” Name Search & History</div>
          <div class="help-step"><div class="help-step-num">â†’</div><div>Start typing your name in the <strong>Full Name</strong> field. After 2 characters, the app auto-searches Google Sheets for your past records.</div></div>
          <div class="help-step"><div class="help-step-num">â†’</div><div>If you've been assessed before, a <strong>history panel</strong> will appear below the form showing all previous BMI scores, sorted newest first.</div></div>
          <div class="help-step"><div class="help-step-num">â†’</div><div>History fetching requires the connection to be <span class="help-chip" style="color:var(--green);border-color:rgba(14,160,106,0.25);background:rgba(14,160,106,0.08)">âœ… Connected</span>.</div></div>
        </div>

        <hr class="help-divider">

        <div class="help-section">
          <div class="help-section-title">ğŸ“ Height Entry Tips</div>
          <div class="help-step"><div class="help-step-num">â†’</div><div>Height must be in <strong>meters</strong> (e.g., 1.75 for 5'9"). Click the <span class="help-chip">â‡…</span> button to open the height converter â€” enter feet & inches or centimeters and click Apply.</div></div>
        </div>

        <hr class="help-divider">

        <div class="help-section">
          <div class="help-section-title">âš–ï¸ About PNP Standards</div>
          <div class="help-step"><div class="help-step-num">â†’</div><div>PNP uses <strong>age-adjusted BMI cutoffs</strong>. The acceptable upper limit increases with age â€” 24.9 for ages 18â€“24, up to 28.9 for ages 40+. See the standards table in the app for the full chart.</div></div>
        </div>

      </div>
    </div>
  </div>

  <!-- FORM -->
  <div class="card">
    <div class="card-title">ğŸ‘¤ Personal Information</div>
    <div class="form-row">
      <div class="field">
        <div class="field-header">
          <label>Full Name *</label>
          <span class="help-btn" tabindex="0">?<span class="tooltip">Enter your complete name as it appears in official records. The app will search your past BMI history as you type.</span></span>
        </div>
        <div class="name-wrapper">
          <input type="text" id="name" placeholder="e.g. Juan dela Cruz" 
oninput="onNameInput(this.value)" onkeydown="onNameKeydown(event)" autocomplete="off" required>
          <div class="autocomplete-list" id="autocompleteList"></div>
        </div>
        <div class="name-hint"><span class="hint-icon">ğŸ”</span> Type 2+ characters to auto-search history</div>
      </div>
      <div class="field">
        <div class="field-header">
          <label>Age *</label>
          <span class="help-btn" tabindex="0">?<span class="tooltip">Enter your age in years (1â€“120). Age affects the PNP acceptable BMI range.</span></span>
        </div>
        <input type="number" id="age" placeholder="e.g. 28" min="1" max="120">
      </div>
    </div>
    <div class="form-row single">
      <div class="field">
        <div class="field-header">
          <label>Weight (kg) *</label>
          <span class="help-btn" tabindex="0">?<span class="tooltip">Enter your current body weight in kilograms. For pounds, multiply lbs Ã— 0.453 to convert to kg.</span></span>
        </div>
        <input type="number" id="weight" placeholder="e.g. 70" min="1" max="500" step="0.1">
      </div>
    </div>
  
    <div class="height-input-row">
      <div class="field">
        <div class="field-header">
          <label>Height (meters) *</label>
          <span class="help-btn" tabindex="0">?<span class="tooltip">Enter height in meters (e.g. 1.75 m). Use the â‡… button to convert from feet/inches or centimeters.</span></span>
        </div>
        <input type="number" id="heightM" placeholder="e.g. 1.75" min="0.5" max="3" step="0.001">
      </div>
      <button class="height-convert-btn" onclick="openConverter()" title="Open height converter (feet, inches, cm â†’ meters)">â‡…</button>
    </div>
    <button class="calc-btn" onclick="calculate()">Calculate BMI</button>
  </div>

  <!-- CREATOR -->
<p style="font-family:'Nunito Sans',sans-serif;font-size:12px;color:var(--muted);text-align:center;margin-top:28px;letter-spacing:0.5px;font-weight:600;">(App by <a href="https://m.me/rekzbanz" target="_blank" style="font-weight:800;color:var(--accent);letter-spacing:0;text-decoration:none;">RekzBanz</a>)</p>
<br>
  <!-- HISTORY -->
  <div class="card history-card" id="historyCard">
    <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
      <span>ğŸ“œ History for "<span id="historyName"></span>"</span>
      <span class="spinner" id="historySpinner" style="display:none;"></span>
    </div>
    <div class="history-list" id="historyList"></div>
  </div>

  <!-- DROPDOWN REFERENCE -->
  <div class="dropdown">
    <button class="dropdown-toggle" id="dropdownToggle" onclick="toggleDropdown()">
      <span>ğŸ“Š PNP BMI Standards & Formula</span>
      <span class="dropdown-arrow">â–¼</span>
    </button>
    <div class="dropdown-content" id="dropdownContent">
      <div class="formula-box">BMI = Weight (kg) Ã· Height (m)Â²</div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;">Standard BMI Categories</div>
      <table class="std-table">
        <thead><tr><th>BMI Range</th><th>Category</th></tr></thead>
        <tbody>
          <tr><td><span class="color-dot" style="background:#3b82f6"></span>&lt; 18.5</td><td>Underweight</td></tr>
          <tr><td><span class="color-dot" style="background:#0ea06a"></span>18.5 â€“ 24.9</td><td>Normal</td></tr>
          <tr><td><span class="color-dot" style="background:#d97b06"></span>25.0 â€“ 29.9</td><td>Overweight</td></tr>
          <tr><td><span class="color-dot" style="background:#e05c1a"></span>30.0 â€“ 34.9</td><td>Obese Class I</td></tr>
          <tr><td><span class="color-dot" style="background:#d93025"></span>35.0 â€“ 39.9</td><td>Obese Class II</td></tr>
          <tr><td><span class="color-dot" style="background:#a81c14"></span>â‰¥ 40.0</td><td>Obese Class III</td></tr>
        </tbody>
      </table>
      <div style="font-size:12px;color:var(--muted);margin-bottom:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;">PNP Acceptable BMI by Age</div>
      <table class="std-table">
        <thead><tr><th>Age Group</th><th>Acceptable BMI Range</th></tr></thead>
        <tbody>
          <tr><td>18 â€“ 24</td><td>18.5 â€“ 24.9</td></tr>
          <tr><td>25 â€“ 29</td><td>18.5 â€“ 25.9</td></tr>
          <tr><td>30 â€“ 34</td><td>18.5 â€“ 26.9</td></tr>
          <tr><td>35 â€“ 39</td><td>18.5 â€“ 27.9</td></tr>
          <tr><td>40+</td><td>18.5 â€“ 28.9</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- HEIGHT CONVERTER MODAL -->
<div class="modal-overlay" id="converterModal" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-title">ğŸ“ Height Converter</div>
    <button class="modal-close" onclick="closeConverter()">âœ•</button>
    <div class="modal-grid">
      <div class="field">
        <label>Meters</label>
        <input type="number" id="convM" placeholder="1.75" step="0.001" min="0.3" max="3" oninput="convFrom('m')">
      </div>
      <div class="field">
        <label>Centimeters</label>
        <input type="number" id="convCm" placeholder="175" step="0.1" min="30" max="300" oninput="convFrom('cm')">
      </div>
      <div class="field">
        <label>Feet</label>
        <input type="number" id="convFt" placeholder="5" step="1" min="1" max="9" oninput="convFrom('ft')">
      </div>
      <div class="field">
        <label>Inches</label>
        <input type="number" id="convIn" placeholder="9" step="0.1" min="0" max="11.9" oninput="convFrom('ft')">
      </div>
    </div>
    <button class="modal-apply-btn" onclick="applyConverter()">âœ” Apply to Height Field</button>
  </div>
</div>

<script>
  // â”€â”€ HARDCODED SCRIPT URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbye4ComyA8u19lx0e2uGX1YOXDACmn1vrEBp7cSSZKxcdMGbbHM4eFEJh1r8QToIVFe/exec';

  // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let lastResult    = null;
  let searchTimeout = null;
  let isConnected   = false;

  // â”€â”€ CONNECTION VERIFICATION ON LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function verifyConnection() {
    const bar  = document.getElementById('connBar');
    const text = document.getElementById('connText');
    bar.className  = 'conn-bar checking';
    text.textContent = 'Verifying Google Sheets connectionâ€¦';

    try {
      // Use a ping-style GET: we expect valid JSON (even empty array []) or any 200 response
      const res = await fetch(SCRIPT_URL + '?ping=1', { method: 'GET', mode: 'cors' });
      if (res.ok) {
        // Try to parse JSON â€” if the sheet returns valid JSON we're good
        const txt = await res.text();
        JSON.parse(txt); // will throw if not JSON
        isConnected = true;
        bar.className  = 'conn-bar connected';
        text.textContent = 'âœ… Connected to cloud';
      } else {
        throw new Error('non-200');
      }
    } catch (err) {
      // fetch with no-cors can't be fully verified, try no-cors fallback ping
      try {
        await fetch(SCRIPT_URL + '?ping=1', { method: 'GET', mode: 'no-cors' });
        // no-cors won't let us read response but if it didn't throw, the server is reachable
        isConnected = true;
        bar.className  = 'conn-bar connected';
        text.textContent = 'âœ… Google Sheets connected â€” cloud save & history are active';
      } catch (e) {
        isConnected = false;
        bar.className  = 'conn-bar failed';
        text.textContent = 'âš ï¸ Could not reach Google Sheets â€” results will not be saved';
      }
    }
  }

  window.addEventListener('load', verifyConnection);

  // â”€â”€ HEIGHT CONVERTER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openConverter() {
    // Pre-populate from current height field value
    const currentM = document.getElementById('heightM').value;
    if (currentM) {
      document.getElementById('convM').value = currentM;
      convFrom('m');
    } else {
      // Clear all
      ['convM','convCm','convFt','convIn'].forEach(id => document.getElementById(id).value = '');
    }
    document.getElementById('converterModal').classList.add('open');
    document.getElementById('convM').focus();
  }

  function closeConverter() {
    document.getElementById('converterModal').classList.remove('open');
  }

  function handleOverlayClick(e) {
    if (e.target === document.getElementById('converterModal')) closeConverter();
  }

  function convFrom(source) {
    const mEl  = document.getElementById('convM');
    const cmEl = document.getElementById('convCm');
    const ftEl = document.getElementById('convFt');
    const inEl = document.getElementById('convIn');

    if (source === 'm') {
      const val = parseFloat(mEl.value);
      if (!isNaN(val) && val > 0) {
        cmEl.value = (val * 100).toFixed(1);
        const totalIn = val / 0.0254;
        ftEl.value = Math.floor(totalIn / 12);
        inEl.value = (totalIn % 12).toFixed(1);
      } else {
        cmEl.value = ''; ftEl.value = ''; inEl.value = '';
      }
    } else if (source === 'cm') {
      const val = parseFloat(cmEl.value);
      if (!isNaN(val) && val > 0) {
        const meters = val / 100;
        mEl.value = meters.toFixed(3);
        const totalIn = val / 2.54;
        ftEl.value = Math.floor(totalIn / 12);
        inEl.value = (totalIn % 12).toFixed(1);
      } else {
        mEl.value = ''; ftEl.value = ''; inEl.value = '';
      }
    } else if (source === 'ft') {
      const f = parseFloat(ftEl.value) || 0;
      const i = parseFloat(inEl.value) || 0;
      if (f > 0 || i > 0) {
        const totalCm = (f * 12 + i) * 2.54;
        mEl.value  = (totalCm / 100).toFixed(3);
        cmEl.value = totalCm.toFixed(1);
      } else {
        mEl.value = ''; cmEl.value = '';
      }
    }
  }

  function applyConverter() {
    const mVal = document.getElementById('convM').value;
    if (!mVal || isNaN(parseFloat(mVal)) || parseFloat(mVal) <= 0) {
      alert('Please enter a valid height value first.');
      return;
    }
    document.getElementById('heightM').value = parseFloat(mVal).toFixed(3);
    document.getElementById('heightM').classList.remove('error');
    closeConverter();
  }

  // â”€â”€ BMI LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getCategory(bmi) {
    if (bmi < 18.5) return 'Underweight';
    if (bmi < 25)   return 'Normal';
    if (bmi < 30)   return 'Overweight';
    if (bmi < 35)   return 'Obese Class I';
    if (bmi < 40)   return 'Obese Class II';
    return 'Obese Class III';
  }

  function getPNPMax(age) {
    if (age < 25) return 24.9;
    if (age < 30) return 25.9;
    if (age < 35) return 26.9;
    if (age < 40) return 27.9;
    return 28.9;
  }

  function getPNPStatus(bmi, age) {
    return (bmi >= 18.5 && bmi <= getPNPMax(age)) ? 'Acceptable' : 'Not Acceptable';
  }

  function getCategoryColor(category) {
    const map = {
      'Underweight':    '#3b82f6',
      'Normal':         '#0ea06a',
      'Overweight':     '#d97b06',
      'Obese Class I':  '#e05c1a',
      'Obese Class II': '#d93025',
      'Obese Class III':'#a81c14'
    };
    return map[category] || '#8890a8';
  }

  // â”€â”€ FORMAT CALCULATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatDate(d) {
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const yr  = d.getFullYear();
  const mon = months[d.getMonth()];
  const day = String(d.getDate()).padStart(2, '0');
  let   h   = d.getHours();
  const min = String(d.getMinutes()).padStart(2, '0');
  const ap  = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  return yr + ' ' + mon + ' ' + day + ', ' + h + ':' + min + ' ' + ap;
}

function parseSheetDate(str) {
  if (!str || str === 'â€”') return 'â€”';
  const d = new Date(str);
  if (isNaN(d.getTime())) return str;
  return formatDate(d);
}


  // â”€â”€ CALCULATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function calculate() {
    
	const nameInput = document.getElementById('name');
const name = nameInput.value.trim();

if (!name) {
  nameInput.classList.add('error');

  // Auto focus + select text
  nameInput.focus();
  nameInput.select();

  // Remove and re-add animation (so it can repeat)
  nameInput.style.animation = 'none';
  nameInput.offsetHeight; // force reflow
  nameInput.style.animation = null;

  alert('âš ï¸ Please enter your full name.');
  return;
} else {
  nameInput.classList.remove('error');
}
	
    const age    = parseInt(document.getElementById('age').value);
    const weight = parseFloat(document.getElementById('weight').value);
    const height = parseFloat(document.getElementById('heightM').value);

    // Validation
    let valid = true;
    ['age','weight','heightM'].forEach(id => {
      const el = document.getElementById(id);
      el.classList.remove('error');
      if (!el.value || isNaN(parseFloat(el.value))) {
        el.classList.add('error');
        valid = false;
      }
    });
    if (!valid) { alert('Please fill in Age, Weight, and Height (meters).'); return; }
    if (age < 1 || age > 120) { alert('Please enter a valid age (1â€“120).'); return; }
    if (height <= 0 || height > 3) { alert('Height must be between 0.5 and 3.0 meters.'); return; }
    if (weight <= 0 || weight > 500) { alert('Please enter a valid weight.'); return; }

    const bmi      = weight / (height * height);
    const bmiFixed = bmi.toFixed(2);
    const category = getCategory(bmi);
    const pnpStatus= getPNPStatus(bmi, age);
    const color    = getCategoryColor(category);
    const date     = formatDate(new Date());
    const pnpMax   = getPNPMax(age);

    // â”€â”€ KG TO LOSE / GAIN CALCULATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let kgDiff = 0;
    let kgBanner = document.getElementById('kgLoseBanner');
    let kgText   = document.getElementById('kgLoseText');
    let kgIcon   = document.getElementById('kgLoseIcon');

    if (bmi > 24.9) {
      // Need to lose weight â€” target BMI 24.9 (upper edge of Normal)
      const targetWeight = 24.9 * height * height;
      kgDiff = +(weight - targetWeight).toFixed(1);
      kgBanner.className = 'kg-lose-banner visible ' + (bmi >= 30 ? 'obese' : 'overweight');
      kgIcon.textContent = 'ğŸ”»';
      kgText.innerHTML = `Need to lose <span class="kg-lose-value">${kgDiff}</span> kg to reach a Normal BMI (24.9). Target weight: <span class="kg-lose-value">${targetWeight.toFixed(1)}</span> kg.`;
    } else if (bmi < 18.5) {
      // Underweight â€” need to gain
      const targetWeight = 18.5 * height * height;
      kgDiff = -(+(targetWeight - weight).toFixed(1));
      kgBanner.className = 'kg-lose-banner visible underweight';
      kgIcon.textContent = 'ğŸ”º';
      const gainAmt = Math.abs(kgDiff);
      kgText.innerHTML = `Need to gain <span class="kg-lose-value">${gainAmt}</span> kg to reach a Normal BMI (18.5). Target weight: <span class="kg-lose-value">${targetWeight.toFixed(1)}</span> kg.`;
    } else {
      kgBanner.className = 'kg-lose-banner visible normal';
      kgIcon.textContent = 'âœ…';
      kgDiff = 0;
      kgText.innerHTML = `You are within the <span class="kg-lose-value">Normal BMI range</span>. No weight adjustment needed!`;
    }

    // Also check vs PNP limit
    let pnpKgNote = '';
    if (bmi > pnpMax) {
      const pnpTargetW = pnpMax * height * height;
      const pnpKgLose = (weight - pnpTargetW).toFixed(1);
      pnpKgNote = ` (PNP limit: lose ${pnpKgLose} kg to reach BMI ${pnpMax})`;
    }

    lastResult = { name: name || 'Anonymous', age, weight, height, bmi: bmiFixed, category, pnpStatus, date, kgToLose: kgDiff, kgNote: pnpKgNote };

    // Update result card
    const card = document.getElementById('resultCard');
    card.style.setProperty('--result-color', color);
    card.classList.add('visible');

    document.getElementById('bmiNumber').textContent = bmiFixed;
    document.getElementById('bmiNumber').style.color = color;
    document.getElementById('categoryBadge').textContent = category;

    const pnpBadge = document.getElementById('pnpBadge');
    if (pnpStatus === 'Acceptable') {
      pnpBadge.textContent = 'âœ… ' + pnpStatus;
      pnpBadge.className = 'badge badge-pnp-ok';
    } else {
      pnpBadge.textContent = 'âŒ ' + pnpStatus;
      pnpBadge.className = 'badge badge-pnp-no';
    }

    document.getElementById('rName').textContent   = name || 'â€”';
    document.getElementById('rAge').textContent    = age;
    document.getElementById('rWeight').textContent = weight + ' kg';
    document.getElementById('rHeight').textContent = height + ' m';
    document.getElementById('rDate').textContent   = date;

    card.scrollIntoView({ behavior:'smooth', block:'start' });
    saveToSheets(lastResult).then(() => {
  if (lastResult.name && lastResult.name !== 'Anonymous') {
    setTimeout(() => {
      fetchHistory(lastResult.name);
    }, 800); // small delay for sheet update
  }
});
  }

  // â”€â”€ GOOGLE SHEETS SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function saveToSheets(data) {
  const statusEl = document.getElementById('saveStatus');
  statusEl.className = 'save-status saving';
  statusEl.innerHTML = '<span class="spinner"></span>Saving to Google Sheetsâ€¦';

  // Build payload including kgToLose
  const payload = {
    name: data.name,
    age: data.age,
    weight: data.weight,
    height: data.height,
    bmi: data.bmi,
    category: data.category,
    pnpStatus: data.pnpStatus,
    date: data.date,
    kgToLose: data.kgToLose !== undefined ? data.kgToLose : ''
  };

  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    statusEl.className = 'save-status saved';
    statusEl.textContent = 'âœ… Saved to Google Sheets';

    return true; // âœ… important
  } catch (err) {
    statusEl.className = 'save-status error';
    statusEl.textContent = 'âš ï¸ Could not save to Google Sheets';

    return false;
  }
}

  // â”€â”€ HELP PANEL TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â”€â”€ HELP MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleHelp() {
    const overlay = document.getElementById('helpModal');
    if (overlay.classList.contains('open')) {
      closeHelp();
    } else {
      openHelp();
    }
  }

  function openHelp() {
    const overlay = document.getElementById('helpModal');
    overlay.style.display = 'flex';
    // Force reflow then add open class for animation
    overlay.offsetHeight;
    overlay.classList.add('open');
    overlay.classList.remove('closing');
    document.body.style.overflow = 'hidden';
  }

  function closeHelp() {
    const overlay = document.getElementById('helpModal');
    overlay.classList.add('closing');
    overlay.classList.remove('open');
    document.body.style.overflow = '';
    setTimeout(() => {
      overlay.style.display = 'none';
      overlay.classList.remove('closing');
    }, 280);
  }

  function handleHelpOverlayClick(e) {
    if (e.target === document.getElementById('helpModal')) closeHelp();
  }

  // Close help modal on Escape key (in addition to converter modal)
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeHelp();
      closeConverter();
    }
  });

  // â”€â”€ AUTOCOMPLETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let nameCache = []; // {name, lastDate, lastBmi, lastCategory}
  let autocompleteActive = -1;

  function onNameKeydown(e) {
    const list = document.getElementById('autocompleteList');
    const items = list.querySelectorAll('.autocomplete-item');
    if (!list.classList.contains('visible') || items.length === 0) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      autocompleteActive = Math.min(autocompleteActive + 1, items.length - 1);
      updateActiveItem(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      autocompleteActive = Math.max(autocompleteActive - 1, 0);
      updateActiveItem(items);
    } else if (e.key === 'Enter' && autocompleteActive >= 0) {
      e.preventDefault();
      items[autocompleteActive].click();
    } else if (e.key === 'Escape') {
      hideAutocomplete();
    }
  }

  function updateActiveItem(items) {
    items.forEach((item, i) => {
      item.classList.toggle('active', i === autocompleteActive);
    });
  }

  function hideAutocomplete() {
    document.getElementById('autocompleteList').classList.remove('visible');
    autocompleteActive = -1;
  }

  function showAutocomplete(matches) {
    const list = document.getElementById('autocompleteList');
    if (!matches || matches.length === 0) { hideAutocomplete(); return; }
    list.innerHTML = '<div class="autocomplete-header">ğŸ“‹ Past records found</div>';
    matches.slice(0, 5).forEach(function(m, idx) {
      const item = document.createElement('div');
      item.className = 'autocomplete-item';
      item.innerHTML =
        '<span class="autocomplete-item-icon">ğŸ‘¤</span>' +
        '<div><div class="autocomplete-item-name">' + m.name + '</div>' +
        '<div class="autocomplete-item-meta">' + (m.lastDate || '') + (m.lastBmi ? ' Â· BMI ' + m.lastBmi : '') + (m.lastCategory ? ' Â· ' + m.lastCategory : '') + '</div></div>';
      item.addEventListener('click', function() {
        document.getElementById('name').value = m.name;
        hideAutocomplete();
        fetchHistory(m.name);
      });
      list.appendChild(item);
    });
    list.classList.add('visible');
    autocompleteActive = -1;
  }

  // Close autocomplete when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.name-wrapper')) hideAutocomplete();
  });

  // â”€â”€ AUTO SEARCH (NAME HISTORY) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function onNameInput(value) {
    clearTimeout(searchTimeout);
    const historyCard = document.getElementById('historyCard');
    const trimmed = value.trim();

    if (!trimmed || trimmed.length < 2) {
      historyCard.classList.remove('visible');
      hideAutocomplete();
      return;
    }

    // Show autocomplete suggestions from cache immediately
    const lc = trimmed.toLowerCase();
    const matches = nameCache.filter(function(m) {
      return m.name.toLowerCase().includes(lc);
    });
    showAutocomplete(matches);

    // Debounce 500ms then fetch
    searchTimeout = setTimeout(() => fetchHistory(trimmed), 500);
  }

  async function fetchHistory(name) {
    const historyCard = document.getElementById('historyCard');
    const spinner     = document.getElementById('historySpinner');
    const list        = document.getElementById('historyList');
    const nameLabel   = document.getElementById('historyName');

    nameLabel.textContent = name;
    historyCard.classList.add('visible');
    spinner.style.display = 'inline-block';
    list.innerHTML = '<div style="color:var(--muted);font-size:13px;text-align:center;padding:12px;">Fetching recordsâ€¦</div>';

    try {
      const res = await fetch(SCRIPT_URL + '?name=' + encodeURIComponent(name), {
        method: 'GET',
        mode: 'cors'
      });

      if (!res.ok) throw new Error('HTTP ' + res.status);

      const records = await res.json();
      spinner.style.display = 'none';

      if (!Array.isArray(records) || records.length === 0) {
        list.innerHTML = '<div style="color:var(--muted);font-size:13px;text-align:center;padding:12px;">No records found for "' + name + '".</div>';
        return;
      }

      // Populate name cache for autocomplete (deduplicate)
      const newest = records[records.length - 1] || {};
      const existingIdx = nameCache.findIndex(function(m){ return m.name.toLowerCase() === name.toLowerCase(); });
      const cacheEntry = { name: newest.name || name, lastDate: newest.date ? parseSheetDate(newest.date) : '', lastBmi: newest.bmi || '', lastCategory: newest.category || '' };
      if (existingIdx >= 0) nameCache[existingIdx] = cacheEntry;
      else nameCache.push(cacheEntry);

      // Show current autocomplete matches
      const lc = (document.getElementById('name').value || '').toLowerCase();
      if (lc.length >= 2) {
        const matches = nameCache.filter(function(m){ return m.name.toLowerCase().includes(lc); });
        showAutocomplete(matches);
      }

      // Show newest records first
      const sorted = records.slice().reverse();
      list.innerHTML = '';
      sorted.forEach(function(r) {
        const color  = getCategoryColor(r.category);
        const pnpOk  = r.pnpStatus === 'Acceptable';
        const bmiVal = parseFloat(r.bmi);
        const div    = document.createElement('div');
        div.className = 'history-item';
        const kgLoseStr = (r.kgToLose !== undefined && r.kgToLose !== '' && r.kgToLose !== null)
          ? (' Â· ' + (parseFloat(r.kgToLose) < 0 ? 'ğŸ”º +' + Math.abs(r.kgToLose) + ' kg needed' : parseFloat(r.kgToLose) > 0 ? 'ğŸ”» -' + r.kgToLose + ' kg to normal' : 'âœ… Normal BMI'))
          : '';
        div.innerHTML =
          '<div>' +
            '<div class="history-bmi" style="color:' + color + '">' + (isNaN(bmiVal) ? r.bmi : bmiVal.toFixed(2)) + '</div>' +
            '<div class="history-meta">' + parseSheetDate(r.date) + ' Â· ' + (r.weight || 'â€”') + ' kg Â· ' + (r.height || 'â€”') + ' m' + kgLoseStr + '</div>' +
          '</div>' +
          '<div class="history-badges">' +
            '<span class="history-badge" style="color:' + color + ';border-color:' + color + ';opacity:0.9;background:' + color + '1a">' + (r.category || 'â€”') + '</span>' +
            '<span class="history-badge" style="' + (pnpOk ? 'color:#0ea06a;border-color:rgba(14,160,106,0.35);background:rgba(14,160,106,0.1)' : 'color:#d93025;border-color:rgba(217,48,37,0.35);background:rgba(217,48,37,0.1)') + '">' + (pnpOk ? 'âœ… OK' : 'âŒ Fail') + '</span>' +
          '</div>';
        list.appendChild(div);
      });

    } catch (err) {
      spinner.style.display = 'none';
      list.innerHTML = '<div style="color:var(--red);font-size:13px;text-align:center;padding:12px;">Could not load history. The Google Sheets API may require CORS â€” results save via no-cors but history read requires the sheet to be published.</div>';
    }
  }

  // â”€â”€ EXPORT TXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function exportTxt() {
    if (!lastResult) return;
    const r = lastResult;
    const kgLine = r.kgToLose < 0
      ? 'Kg to Gain  : ' + Math.abs(r.kgToLose) + ' kg (to reach Normal BMI)'
      : r.kgToLose > 0
      ? 'Kg to Lose  : ' + r.kgToLose + ' kg (to reach Normal BMI)'
      : 'Kg Adjust   : None â€” already at Normal BMI';
    const content =
      'PNP BMI CALCULATOR â€” RESULT REPORT\n' +
      '=====================================\n' +
      'Date       : ' + r.date + '\n' +
      'Name       : ' + r.name + '\n' +
      'Age        : ' + r.age + '\n' +
      'Weight     : ' + r.weight + ' kg\n' +
      'Height     : ' + r.height + ' m\n' +
      '-------------------------------------\n' +
      'BMI Score  : ' + r.bmi + '\n' +
      'Category   : ' + r.category + '\n' +
      'PNP Status : ' + r.pnpStatus + '\n' +
      kgLine + '\n' +
      '=====================================\n' +
      'Generated by PNP BMI Calculator';

    const blob = new Blob([content], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = (r.name !== 'Anonymous' ? r.name.replace(/\s+/g,'_') : 'BMI_Result') + '.txt';
    link.click();
  }

  // â”€â”€ DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleDropdown() {
    document.getElementById('dropdownToggle').classList.toggle('open');
    document.getElementById('dropdownContent').classList.toggle('open');
  }
// â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const saved = localStorage.getItem('bmi-theme') || 'dark';
  applyTheme(saved);
})();

function applyTheme(theme) {
  if (theme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
  const btn   = document.getElementById('themeBtn');
  const label = document.getElementById('themeLabel');
  if (!btn) return;
  if (theme === 'light') {
    document.querySelector('.theme-icon').textContent = 'â˜€ï¸';
    label.textContent = 'Light';
  } else {
    document.querySelector('.theme-icon').textContent = 'ğŸŒ™';
    label.textContent = 'Dark';
  }
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  // No attribute = light (default). 'dark' = dark.
  const next = current === 'dark' ? 'light' : 'dark';
  localStorage.setItem('bmi-theme', next);
  applyTheme(next);
}
</script>
</body>
</html>
